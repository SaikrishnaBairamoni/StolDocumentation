\hypertarget{vehicle__scheduler_8cpp_source}{}\doxysection{vehicle\+\_\+scheduler.\+cpp}
\label{vehicle__scheduler_8cpp_source}\index{streets\_utils/streets\_vehicle\_scheduler/src/vehicle\_scheduler.cpp@{streets\_utils/streets\_vehicle\_scheduler/src/vehicle\_scheduler.cpp}}
\mbox{\hyperlink{vehicle__scheduler_8cpp}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00001}00001 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{vehicle__scheduler_8h}{vehicle\_scheduler.h}}"{}}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00002}00002 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00003}00003 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespacestreets__vehicle__scheduler}{streets\_vehicle\_scheduler}} \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00004}\mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a843b25b73b376d77df5a8d5e77f818d2}{00004}}     std::shared\_ptr<OpenAPI::OAIIntersection\_info> \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a843b25b73b376d77df5a8d5e77f818d2}{vehicle\_scheduler::get\_intersection\_info}}()\textcolor{keyword}{ const}\{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00005}00005         \textcolor{keywordflow}{return} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a5fa37276e5ccb41e38cbef573e830e8e}{intersection\_info}};}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00006}00006     \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00007}00007 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00008}\mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a8b666aed7fe6d72a268315baeb1f85e1}{00008}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a8b666aed7fe6d72a268315baeb1f85e1}{vehicle\_scheduler::set\_intersection\_info}}( std::shared\_ptr<OpenAPI::OAIIntersection\_info> \_intersection\_info) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00009}00009         \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a5fa37276e5ccb41e38cbef573e830e8e}{intersection\_info}} = \_intersection\_info;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00010}00010     \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00011}00011 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00012}00012 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00013}\mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_af8916add714bef70d8f48efc0ccfca7b}{00013}}     \mbox{\hyperlink{classOpenAPI_1_1OAILanelet__info}{OpenAPI::OAILanelet\_info}} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_af8916add714bef70d8f48efc0ccfca7b}{vehicle\_scheduler::get\_entry\_lanelet\_info}}(\textcolor{keyword}{const} \mbox{\hyperlink{structstreets__vehicles_1_1vehicle}{streets\_vehicles::vehicle}} \&veh)\textcolor{keyword}{ const}\{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00014}00014         \mbox{\hyperlink{classOpenAPI_1_1OAILanelet__info}{OpenAPI::OAILanelet\_info}} entry\_lane;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00015}00015         \textcolor{keywordtype}{bool} is\_found = \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00016}00016         \textcolor{keywordflow}{for} (\textcolor{keyword}{const} \textcolor{keyword}{auto} \&lanelet : \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a5fa37276e5ccb41e38cbef573e830e8e}{intersection\_info}}-\/>getEntryLanelets() ) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00017}00017             \textcolor{keywordtype}{int} lane\_id =lanelet.\mbox{\hyperlink{classOpenAPI_1_1OAILanelet__info_a489d1a475686159298697bccabd2bd52}{getId}}();}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00018}00018             \textcolor{keywordflow}{if} ( lane\_id == veh.\mbox{\hyperlink{structstreets__vehicles_1_1vehicle_a4ef0e2e811b0f5cb00f14b89a353c3b5}{\_entry\_lane\_id}} ) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00019}00019                 entry\_lane =  lanelet;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00020}00020                 is\_found = \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00021}00021             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00022}00022             }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00023}00023         \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00024}00024         \textcolor{keywordflow}{if} (!is\_found) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00025}00025             \textcolor{keywordflow}{throw} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1scheduling__exception}{scheduling\_exception}}(\textcolor{stringliteral}{"{}No entry lane "{}} + \mbox{\hyperlink{ntcip__1202__ext_8h_a576de7b60eacee3f1a70393a005502cd}{std::to\_string}}(veh.\mbox{\hyperlink{structstreets__vehicles_1_1vehicle_adc3dab0260f149fc908b9b7d49e1ba99}{\_cur\_lane\_id}}) + \textcolor{stringliteral}{"{} found in intersection info!"{}});}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00026}00026         \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00027}00027         \textcolor{keywordflow}{return} entry\_lane;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00028}00028 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00029}00029     \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00030}00030 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00031}\mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_af2c80eb87e5a9cabaad660544003663c}{00031}}      \mbox{\hyperlink{classOpenAPI_1_1OAILanelet__info}{OpenAPI::OAILanelet\_info}} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_af2c80eb87e5a9cabaad660544003663c}{vehicle\_scheduler::get\_link\_lanelet\_info}}(\textcolor{keyword}{const} \mbox{\hyperlink{structstreets__vehicles_1_1vehicle}{streets\_vehicles::vehicle}} \&veh)\textcolor{keyword}{ const}\{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00032}00032         \mbox{\hyperlink{classOpenAPI_1_1OAILanelet__info}{OpenAPI::OAILanelet\_info}} link\_lane;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00033}00033         \textcolor{keywordtype}{bool} is\_found = \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00034}00034         \textcolor{keywordflow}{for} ( \textcolor{keyword}{const} \textcolor{keyword}{auto} \&lanelet : \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a5fa37276e5ccb41e38cbef573e830e8e}{intersection\_info}}-\/>getLinkLanelets() ) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00035}00035             \textcolor{keywordtype}{int} lane\_id = lanelet.\mbox{\hyperlink{classOpenAPI_1_1OAILanelet__info_a489d1a475686159298697bccabd2bd52}{getId}}();}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00036}00036             \textcolor{keywordflow}{if} ( lane\_id == veh.\mbox{\hyperlink{structstreets__vehicles_1_1vehicle_aaa9cbe97b2343b3f14841c1ed2bc8e3d}{\_link\_id}} ) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00037}00037                 link\_lane =  lanelet;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00038}00038                 is\_found = \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00039}00039             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00040}00040             }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00041}00041         \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00042}00042         \textcolor{keywordflow}{if} (!is\_found) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00043}00043             \textcolor{keywordflow}{throw} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1scheduling__exception}{scheduling\_exception}}(\textcolor{stringliteral}{"{}No link lane "{}} + \mbox{\hyperlink{ntcip__1202__ext_8h_a576de7b60eacee3f1a70393a005502cd}{std::to\_string}}(veh.\mbox{\hyperlink{structstreets__vehicles_1_1vehicle_adc3dab0260f149fc908b9b7d49e1ba99}{\_cur\_lane\_id}}) + \textcolor{stringliteral}{"{} found in intersection info!"{}});}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00044}00044         \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00045}00045         \textcolor{keywordflow}{return} link\_lane;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00046}00046 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00047}00047     \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00048}00048 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00049}\mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a85947f43b293504a108619374c0c0dae}{00049}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1vehicle__scheduler_a85947f43b293504a108619374c0c0dae}{vehicle\_scheduler::estimate\_vehicles\_at\_common\_time}}( std::unordered\_map<std::string,streets\_vehicles::vehicle> \&vehicles, }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00050}00050                                                                 \textcolor{keyword}{const} u\_int64\_t \mbox{\hyperlink{namespacesimulate__mobilityoperation_a53dff21a6d447ca660693de3432b79d0}{timestamp}})\textcolor{keyword}{ const }\{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00051}00051         \textcolor{keywordflow}{for} ( \textcolor{keyword}{auto} \&[v\_id, veh]: vehicles) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00052}00052             \textcolor{comment}{// Time difference in seconds}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00053}00053             \textcolor{keywordtype}{double} delta\_t = (double)(\mbox{\hyperlink{namespacesimulate__mobilityoperation_a53dff21a6d447ca660693de3432b79d0}{timestamp}} -\/ veh.\_cur\_time)/1000.0;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00054}00054             \textcolor{keywordflow}{if} ( delta\_t > 500.0 ) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00055}00055                 SPDLOG\_WARN(\textcolor{stringliteral}{"{}Vehicle update \{0\} is older than 5 times the vehicle update interval (500 ms)!"{}}, veh.\_id);}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00056}00056             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00057}00057             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( delta\_t > 200.0) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00058}00058                 SPDLOG\_WARN(\textcolor{stringliteral}{"{}Vehicle update \{0\} is older than double the vehicle update interval (200 ms)!"{}}, veh.\_id);}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00059}00059             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00060}00060             \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} ( delta\_t < 0) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00061}00061                 \textcolor{keywordflow}{throw} \mbox{\hyperlink{classstreets__vehicle__scheduler_1_1scheduling__exception}{scheduling\_exception}}(\textcolor{stringliteral}{"{}Timestamp "{}}+ \mbox{\hyperlink{ntcip__1202__ext_8h_a576de7b60eacee3f1a70393a005502cd}{std::to\_string}}(\mbox{\hyperlink{namespacesimulate__mobilityoperation_a53dff21a6d447ca660693de3432b79d0}{timestamp}}) + \textcolor{stringliteral}{"{} is earlier that latest vehicle update "{}} }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00062}00062                     + \mbox{\hyperlink{ntcip__1202__ext_8h_a576de7b60eacee3f1a70393a005502cd}{std::to\_string}}(veh.\_cur\_time) + \textcolor{stringliteral}{"{} Vehicles can only be scheduled for current or future time."{}});}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00063}00063             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00064}00064             \textcolor{comment}{// estimate future speed.}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00065}00065             \textcolor{keywordtype}{double} v\_final = veh.\_cur\_speed + veh.\_cur\_accel*delta\_t;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00066}00066             \textcolor{comment}{// estimate change in distance}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00067}00067             \textcolor{keywordtype}{double} delta\_x = ((v\_final + veh.\_cur\_speed)/2.0)*delta\_t;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00068}00068             SPDLOG\_DEBUG(\textcolor{stringliteral}{"{}Setting speed for vehicle \{0\} from \{1\}m/s to \{2\}m/s."{}}, }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00069}00069                             veh.\_id, }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00070}00070                             veh.\_cur\_speed, }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00071}00071                             v\_final );}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00072}00072             veh.\_cur\_speed = v\_final;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00073}00073             veh.\_cur\_time =  \mbox{\hyperlink{namespacesimulate__mobilityoperation_a53dff21a6d447ca660693de3432b79d0}{timestamp}};}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00074}00074             \textcolor{comment}{// Estimate distance to end of lanelet}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00075}00075             \textcolor{keywordflow}{if} ( veh.\_cur\_distance -\/ delta\_x >= 0.0) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00076}00076                 SPDLOG\_DEBUG(\textcolor{stringliteral}{"{}Setting distance for vehicle \{0\} from \{1\}m to \{2\}m."{}}, }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00077}00077                             veh.\_id, }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00078}00078                             veh.\_cur\_distance, }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00079}00079                             veh.\_cur\_distance-\/delta\_x );}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00080}00080 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00081}00081                 veh.\_cur\_distance -\/= delta\_x;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00082}00082             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00083}00083             \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00084}00084                 \textcolor{comment}{// TODO: Could add lanelet transition estimation with intersection model information.}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00085}00085                 veh.\_cur\_distance =  0.0;}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00086}00086             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00087}00087             \textcolor{comment}{// Remove all future points not older than timestamp for estimation.}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00088}00088             \textcolor{keywordflow}{for} (\textcolor{keyword}{auto} it = veh.\_future\_info.begin() ; it != veh.\_future\_info.end(); it++ ) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00089}00089                 \textcolor{keywordflow}{if} ( \mbox{\hyperlink{namespacesimulate__mobilityoperation_a53dff21a6d447ca660693de3432b79d0}{timestamp}} > it-\/>timestamp ) \{}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00090}00090                     veh.\_future\_info.erase( it-\/-\/);}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00091}00091                 \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00092}00092             \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00093}00093 }
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00094}00094         \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00095}00095     \}}
\DoxyCodeLine{\Hypertarget{vehicle__scheduler_8cpp_source_l00096}00096 \}}

\end{DoxyCode}
